import React, { useState, useEffect, useCallback } from 'react';
import { Switch } from "@/components/ui/switch";
import { motion, AnimatePresence } from "framer-motion";
import { ArrowLeft } from 'lucide-react';
import { Link } from 'react-router-dom';

const EMPTY = null;
const X = 'X';
const O = 'O';

// Minimax algorithm to find the best move
function minimax(board, depth, isMaximizing, player, opponent) {
  const winner = checkWinner(board);
  
  if (winner === player) return 10 - depth;
  if (winner === opponent) return depth - 10;
  if (isBoardFull(board)) return 0;
  
  if (isMaximizing) {
    let bestScore = -Infinity;
    for (let i = 0; i < 9; i++) {
      if (board[i] === EMPTY) {
        board[i] = player;
        const score = minimax(board, depth + 1, false, player, opponent);
        board[i] = EMPTY;
        bestScore = Math.max(score, bestScore);
      }
    }
    return bestScore;
  } else {
    let bestScore = Infinity;
    for (let i = 0; i < 9; i++) {
      if (board[i] === EMPTY) {
        board[i] = opponent;
        const score = minimax(board, depth + 1, true, player, opponent);
        board[i] = EMPTY;
        bestScore = Math.min(score, bestScore);
      }
    }
    return bestScore;
  }
}

function findBestMove(board, player) {
  const opponent = player === X ? O : X;
  let bestScore = -Infinity;
  let bestMove = -1;
  
  for (let i = 0; i < 9; i++) {
    if (board[i] === EMPTY) {
      board[i] = player;
      const score = minimax(board, 0, false, player, opponent);
      board[i] = EMPTY;
      if (score > bestScore) {
        bestScore = score;
        bestMove = i;
      }
    }
  }
  return bestMove;
}

function checkWinner(board) {
  const lines = [
    [0, 1, 2], [3, 4, 5], [6, 7, 8],
    [0, 3, 6], [1, 4, 7], [2, 5, 8],
    [0, 4, 8], [2, 4, 6]
  ];
  
  for (const [a, b, c] of lines) {
    if (board[a] && board[a] === board[b] && board[a] === board[c]) {
      return board[a];
    }
  }
  return null;
}

function isBoardFull(board) {
  return board.every(cell => cell !== EMPTY);
}

export default function TicTacToe() {
  const urlParams = new URLSearchParams(window.location.search);
  const gameMode = urlParams.get('mode') || 'normal';
  
  const [board, setBoard] = useState(Array(9).fill(EMPTY));
  const [mySymbol, setMySymbol] = useState(X);
  const [iPlayFirst, setIPlayFirst] = useState(true);
  const [autoPlay, setAutoPlay] = useState(false);
  const [bestMove, setBestMove] = useState(-1);
  const [lastPlacedByOpponent, setLastPlacedByOpponent] = useState(null);
  const [pieceHistory, setPieceHistory] = useState({ [X]: [], [O]: [] });

  const opponent = mySymbol === X ? O : X;
  const winner = checkWinner(board);
  const gameOver = winner || isBoardFull(board);

  // Calculate whose turn it is based on board state
  const xCount = board.filter(c => c === X).length;
  const oCount = board.filter(c => c === O).length;
  const firstPlayer = iPlayFirst ? mySymbol : opponent;
  
  let currentTurn;
  if (firstPlayer === X) {
    currentTurn = xCount <= oCount ? X : O;
  } else {
    currentTurn = oCount <= xCount ? O : X;
  }

  const isMyTurn = currentTurn === mySymbol;

  // Calculate best move whenever board changes
  useEffect(() => {
    if (!gameOver && isMyTurn) {
      const move = findBestMove([...board], mySymbol);
      setBestMove(move);
    } else {
      setBestMove(-1);
    }
  }, [board, mySymbol, gameOver, isMyTurn]);

  // Auto-play logic
  useEffect(() => {
    if (autoPlay && !gameOver && isMyTurn && lastPlacedByOpponent !== null) {
      const move = findBestMove([...board], mySymbol);
      if (move !== -1) {
        const timer = setTimeout(() => {
          handleCellClick(move);
        }, 300);
        return () => clearTimeout(timer);
      }
    }
  }, [autoPlay, board, mySymbol, gameOver, isMyTurn, lastPlacedByOpponent]);

  const handleCellClick = (index) => {
    if (gameOver) return;
    
    const newBoard = [...board];
    const newHistory = { X: [...pieceHistory[X]], O: [...pieceHistory[O]] };
    
    if (board[index] === EMPTY || board[index] === currentTurn) {
      // If clicking on own piece, remove it first
      if (board[index] === currentTurn) {
        newBoard[index] = EMPTY;
        newHistory[currentTurn] = newHistory[currentTurn].filter(i => i !== index);
      }
      
      // Rush mode: remove oldest piece of this symbol if it has 3 pieces
      if (gameMode === 'rush' && newHistory[currentTurn].length >= 3) {
        const oldestIndex = newHistory[currentTurn][0];
        if (newBoard[oldestIndex] !== EMPTY) {
          newBoard[oldestIndex] = EMPTY;
        }
        newHistory[currentTurn].shift();
      }
      
      // Place piece for current turn
      newBoard[index] = currentTurn;
      newHistory[currentTurn].push(index);
      
      setPieceHistory(newHistory);
      setBoard(newBoard);
      
      if (currentTurn === opponent) {
        setLastPlacedByOpponent(index);
      } else {
        setLastPlacedByOpponent(null);
      }
    } else {
      // Remove opponent piece if clicking on it
      const pieceSymbol = board[index];
      newBoard[index] = EMPTY;
      newHistory[pieceSymbol] = newHistory[pieceSymbol].filter(i => i !== index);
      setPieceHistory(newHistory);
      setBoard(newBoard);
      setLastPlacedByOpponent(null);
    }
  };

  const resetGame = () => {
    setBoard(Array(9).fill(EMPTY));
    setBestMove(-1);
    setLastPlacedByOpponent(null);
    setPieceHistory({ [X]: [], [O]: [] });
  };

  const handleSymbolChange = (symbol) => {
    setMySymbol(symbol);
    resetGame();
  };

  const handleFirstChange = (meFirst) => {
    setIPlayFirst(meFirst);
    resetGame();
  };

  return (
    <div className="min-h-screen bg-[#0f0f1a] flex flex-col items-center justify-between py-6 px-4 font-sans">
      {/* Top Settings */}
      <div className="w-full max-w-xs space-y-4">
        <div className="flex items-center justify-between mb-2">
          <Link to="/Index">
            <button className="w-10 h-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all">
              <ArrowLeft className="w-5 h-5 text-gray-400" />
            </button>
          </Link>
          <h1 className="text-lg font-bold text-white">Tic Tac Toe</h1>
          <div className="w-10" />
        </div>
        {/* I am */}
        <div className="flex items-center justify-between">
          <span className="text-gray-400 text-sm font-medium tracking-wide">I am</span>
          <div className="flex gap-2">
            <button
              onClick={() => handleSymbolChange(X)}
              className={`w-12 h-10 rounded-xl font-bold text-lg transition-all duration-200 ${
                mySymbol === X 
                  ? 'bg-blue-500/20 text-blue-400 ring-2 ring-blue-500/50' 
                  : 'bg-white/5 text-gray-500 hover:bg-white/10'
              }`}
            >
              X
            </button>
            <button
              onClick={() => handleSymbolChange(O)}
              className={`w-12 h-10 rounded-xl font-bold text-lg transition-all duration-200 ${
                mySymbol === O 
                  ? 'bg-rose-500/20 text-rose-400 ring-2 ring-rose-500/50' 
                  : 'bg-white/5 text-gray-500 hover:bg-white/10'
              }`}
            >
              O
            </button>
          </div>
        </div>

        {/* First move */}
        <div className="flex items-center justify-between">
          <span className="text-gray-400 text-sm font-medium tracking-wide">First move</span>
          <div className="flex gap-2">
            <button
              onClick={() => handleFirstChange(true)}
              className={`px-4 h-10 rounded-xl text-sm font-medium transition-all duration-200 ${
                iPlayFirst 
                  ? 'bg-indigo-500/20 text-indigo-400 ring-2 ring-indigo-500/50' 
                  : 'bg-white/5 text-gray-500 hover:bg-white/10'
              }`}
            >
              Me
            </button>
            <button
              onClick={() => handleFirstChange(false)}
              className={`px-4 h-10 rounded-xl text-sm font-medium transition-all duration-200 ${
                !iPlayFirst 
                  ? 'bg-indigo-500/20 text-indigo-400 ring-2 ring-indigo-500/50' 
                  : 'bg-white/5 text-gray-500 hover:bg-white/10'
              }`}
            >
              Opponent
            </button>
          </div>
        </div>
      </div>

      {/* Game Board */}
      <div className="relative">
        <div className="grid grid-cols-3 gap-2 p-3 bg-white/5 rounded-2xl backdrop-blur-sm">
          {board.map((cell, index) => (
            <motion.button
              key={index}
              onClick={() => handleCellClick(index)}
              whileTap={{ scale: 0.95 }}
              className={`w-20 h-20 rounded-xl flex items-center justify-center text-4xl font-bold transition-all duration-200 relative ${
                cell === EMPTY 
                  ? 'bg-[#1a1a2e] hover:bg-[#252540]' 
                  : 'bg-[#1a1a2e]'
              } ${
                bestMove === index && !gameOver && isMyTurn
                  ? 'ring-2 ring-emerald-400/70 ring-offset-2 ring-offset-[#0f0f1a]' 
                  : ''
              }`}
            >
              <AnimatePresence mode="wait">
                {cell && (
                  <motion.span
                    initial={{ scale: 0, rotate: -180 }}
                    animate={{ scale: 1, rotate: 0 }}
                    exit={{ scale: 0, rotate: 180 }}
                    className={cell === X ? 'text-blue-400' : 'text-rose-400'}
                  >
                    {cell}
                  </motion.span>
                )}
                {cell === EMPTY && bestMove === index && !gameOver && isMyTurn && (
                  <motion.span
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 0.4 }}
                    className={`text-2xl ${mySymbol === X ? 'text-blue-400' : 'text-rose-400'}`}
                  >
                    {mySymbol}
                  </motion.span>
                )}
              </AnimatePresence>
            </motion.button>
          ))}
        </div>
      </div>

      {/* Bottom Section */}
      <div className="w-full max-w-xs space-y-4">
        {/* Status */}
        <div className="text-center h-8">
          {winner ? (
            <motion.p 
              initial={{ scale: 0.8, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              className={`text-lg font-semibold ${
                winner === mySymbol ? 'text-emerald-400' : 'text-rose-400'
              }`}
            >
              {winner === mySymbol ? 'You win! ðŸŽ‰' : 'Opponent wins'}
            </motion.p>
          ) : isBoardFull(board) ? (
            <p className="text-gray-400 text-lg font-medium">Draw!</p>
          ) : (
            <p className="text-gray-500 text-sm">
              {isMyTurn ? (
                <span className="text-emerald-400">Your turn â€” play suggested move</span>
              ) : (
                <span>Tap to place opponent's move</span>
              )}
            </p>
          )}
        </div>

        {/* Auto Play Toggle */}
        <div className="flex items-center justify-between bg-white/5 rounded-2xl px-5 py-4">
          <div>
            <p className="text-white text-sm font-medium">Auto-play</p>
            <p className="text-gray-500 text-xs">Auto-fill my best move</p>
          </div>
          <Switch
            checked={autoPlay}
            onCheckedChange={setAutoPlay}
            className="data-[state=checked]:bg-indigo-500"
          />
        </div>

        {/* Reset Button */}
        <button
          onClick={resetGame}
          className="w-full py-3 rounded-xl bg-white/5 text-gray-400 text-sm font-medium hover:bg-white/10 transition-all duration-200"
        >
          Reset Game
        </button>
      </div>
    </div>
  );
}